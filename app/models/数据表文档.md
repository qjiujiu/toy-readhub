线下还书依旧需要验证身份信息，因为系统不是对每一本图书都有一个特定的编号，所以有多本相同的书被不同的人借走，还书时不进行身份认证，是不知道这本是谁还的。

这个系统还不允许一个人借多本相同的书，同样是因为每本书都没特定的编号。由于借书时间不同，还书期限也不同，所以还书时不知道还的是哪本。

既然还书的时候需要身份认证，所以请求体需要包含图书信息和身份信息，由student_id，isbn 以及 warehouse 定位到 order_id，然后再更新图书的借阅状态。

经过考量决定重新设计数据表，提出以下3个方案

### 方案一：book表保持不变

**isbn 应该与 bid 绑定，即每一本书都有唯一的 isbn 号。**

**book 表保持不变，那么所有图书（无论是否相同）都应存入 book 表中，而book作为静态表，这时候 book_location 中的字段可以一并合并到 book 表中。**

**图书表 book 字段**

* **初始：bid, title, author, isbn, abstract, tags**
* 变更：bid, title, author, isbn, abstract, tags, **area, floor, warehouse_name**

**此时库存表外键不能是book_id， 不然每本书的库存量都是 1，外键可以是 author 和 title 以及 warehouse_name，用书名和作者名以及校区位置3个字段定位相同的图书。**

**图书库存表 book_inventory 字段**

* **初始：inv_id, book_id, warehouse_name, quantity**
* 变更：inv_id, **author, title**, warehouse_name, quantity

### 方案二：book 表添加字段

**book 表再多加一个字段 same_id，相同图书（具有相同的作者和书名） 具有相同的 same_id 值。**

**在插入book 表之前先查找该图书是否已经存在（用 author 和 title 联合查找）**

* **不存在，直接插入，book_id 保持自增，该书 same_id 的值等于 book_id 值**

  * **还要插入 book_location, book_inventory 表**
* **存在，记录相同图书的 same_id 值，直接插入，book_id 保持自增，该书 same_id 的值等于相同图书的 same_id 值**

  * **跳过book_location 表，在 book_inventory 表添加库存**

**各表字段变化：**

**图书表 book 字段：bid, ****same_id**, title, author, isbn, abstract, tags                           （添加 same_id 字段）

**图书位置表 book_location 字段：loc_id, ****same_id**, area, floor, warehouse_name   （原本book_id 改为 same_id）

**图书库存表 book_inventory 字段：inv_id, ****same_id**, warehouse_name, quantity    （原本book_id 改为 same_id）

**借阅表 order 字段：order_id, user_id, book_id, warehouse_name, status, borrow_time, return_time （不变）**

### 方案三： book 表删除字段

**book 表删除 isbn 字段：bid, title, author, abstract, tags**

新建一个 book_isbn 表用于记录唯一的isbn，包含：**unique_id（主键，自增）, isbn**

book_location表 和 book_inventory 表 ****保持不变**

* **book_location表 ：loc_id, book_id, area, floor, warehouse_name**
* **book_inventory 表：inv_id, book_id, warehouse_name, quantity**

order 字段：order_id, user_id, **unique_id**, warehouse_name, status, borrow_time, return_time （原本book_id 改为 unique_id）

**插入图书：**

* **在插入之前先查找 book 表中是否已有相同图书存在（用 author 和 title 联合查找）**

  * 存在，跳过不插入 book 表 和 book_location 表，但是从book表中获取 book_id 联立 warehouse 在book_inventory表插入新记录或者添加库存 quantity
  * **不存在，插入 book 表，book_location 表，book_inventory 表**
* 插入 book_isbn 表


综合看下来，我觉得方案1-2，成本最小，方案2-3，业务逻辑最合理。最终选择方案2，因为合理，并且改动幅度小。
